# 声纹登录功能说明

## 功能概述

本系统新增了基于声纹特征的登录功能，用户可以通过说出指定语句进行身份验证，无需输入密码。

## 功能特性

### 前端功能
- **登录界面**: 美观的模态框界面，引导用户进行声纹验证
- **实时状态**: 显示录音、处理、成功/失败等状态
- **用户信息**: 登录后显示用户名、角色等信息
- **退出登录**: 一键退出功能

### 后端功能
- **声纹验证**: 使用pyannote.audio进行声纹特征提取和匹配
- **用户管理**: 自动创建或更新用户信息
- **安全验证**: 音频质量检查和错误处理

## 使用方法

### 1. 用户注册
首先需要通过 `/register-voice` 接口注册声纹：
```bash
curl -X POST "http://localhost:8000/register-voice" \
  -F "audio=@voice_sample.wav" \
  -F "user_name=张三" \
  -F "role=GUEST"
```

### 2. 声纹登录
用户在前端点击"声纹登录"按钮，按照提示说出验证语句：
> "我是智能会议助手用户，正在进行声纹验证"

### 3. 登录流程
1. 用户点击"声纹登录"按钮
2. 系统请求麦克风权限
3. 用户说出验证语句（5秒录音）
4. 系统提取声纹特征
5. 与数据库中的声纹进行匹配
6. 返回登录结果

## API接口

### POST /voice-login
声纹登录验证接口

**请求参数:**
```json
{
  "audio_data": [0.1, 0.2, 0.3, ...],  // 音频数据数组
  "sample_rate": 16000                  // 采样率
}
```

**响应格式:**
```json
{
  "status": "success",
  "message": "声纹验证成功",
  "user": {
    "_id": "user_id",
    "name": "用户名",
    "role": "角色",
    "last_active": "2024-01-01T00:00:00Z"
  }
}
```

## 技术实现

### 前端实现
- **音频采集**: 使用Web Audio API和AudioWorklet
- **状态管理**: React Context管理登录状态
- **UI组件**: 模态框组件显示登录界面

### 后端实现
- **声纹识别**: 使用pyannote.audio的embedding模型
- **向量匹配**: 使用Milvus向量数据库进行相似度搜索
- **用户管理**: MongoDB存储用户信息

## 配置要求

### 环境变量
```bash
# 声纹识别相关
VOICE_SAMPLE_RATE=16000
VOICE_EMBEDDING_DIM=512
MIN_SPEECH_SEGMENT_DURATION=1.5
VOICEPRINT_SIMILARITY_THRESHOLD=0.8

# 数据库配置
MILVUS_HOST=localhost
MILVUS_PORT=19530
MONGO_HOST=localhost
MONGO_PORT=27017
```

### 依赖包
- pyannote.audio
- pymilvus
- pymongo
- numpy
- fastapi

## 安全考虑

1. **音频质量检查**: 验证音频时长和数据完整性
2. **相似度阈值**: 设置合理的声纹匹配阈值
3. **错误处理**: 完善的异常处理机制
4. **用户隐私**: 音频数据不存储，仅提取特征

## 故障排除

### 常见问题

1. **麦克风权限被拒绝**
   - 确保浏览器允许麦克风访问
   - 检查HTTPS连接（生产环境）

2. **声纹识别失败**
   - 确保音频质量良好
   - 检查是否已注册声纹
   - 调整相似度阈值

3. **服务未就绪**
   - 检查后端服务是否启动
   - 验证数据库连接
   - 确认模型已加载

### 调试方法

1. **查看浏览器控制台**: 检查前端错误信息
2. **查看后端日志**: 检查服务状态和错误
3. **使用测试脚本**: 运行 `test_voice_login.py`

## 未来改进

1. **多语言支持**: 支持不同语言的验证语句
2. **声纹更新**: 允许用户更新声纹特征
3. **批量注册**: 支持批量用户注册
4. **安全增强**: 添加防重放攻击机制

